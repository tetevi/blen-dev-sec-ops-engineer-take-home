name: Merge to Main

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  terraform-checks:
    name: Terraform Validate & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Format Check
        run: terraform fmt -check -recursive

      - name: Terraform Init
        run: terraform init -backend=false

      - name: Terraform Validate
        run: terraform validate

      - name: Setup TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Run TFLint
        run: tflint --recursive --minimum-failure-severity=error

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: terraform
          framework: terraform
          soft_fail: true

  docker-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run hadolint
        uses: hadolint/hadolint-action@v3.1.0
        with:
          dockerfile: app/Dockerfile
          failure-threshold: error

  docker-build-and-scan:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t app:${{ github.sha }} ./app

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: app:${{ github.sha }}
          format: table
          exit-code: 0
          severity: CRITICAL,HIGH

  app-security:
    name: Application Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        working-directory: app
        run: npm ci

      - name: Run npm audit
        working-directory: app
        run: npm audit --audit-level=high
        continue-on-error: true

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  docker-compose-test:
    name: Docker Compose Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start services
        run: docker compose up -d --build

      - name: Wait for services to be healthy
        run: |
          for i in $(seq 1 30); do
            if curl -sf http://localhost:3000/api/db-check > /dev/null 2>&1; then
              echo "Services are ready!"
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Timed out waiting for services"
              docker compose logs
              exit 1
            fi
            echo "Waiting for services... (attempt $i/30)"
            sleep 2
          done

      - name: Verify db-check endpoint
        run: |
          response=$(curl -sf http://localhost:3000/api/db-check)
          echo "$response"
          echo "$response" | grep -q '"success":true'

      - name: Tear down services
        if: always()
        run: docker compose down

  build-and-push:
    name: Build & Push to GHCR
    runs-on: ubuntu-latest
    needs:
      - terraform-checks
      - docker-lint
      - docker-build-and-scan
      - app-security
      - secret-detection
      - docker-compose-test
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          IMAGE_NAME=ghcr.io/$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          docker build -t $IMAGE_NAME:${{ github.sha }} -t $IMAGE_NAME:latest ./app
          docker push $IMAGE_NAME:${{ github.sha }}
          docker push $IMAGE_NAME:latest

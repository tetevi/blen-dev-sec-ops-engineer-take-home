name: Merge to Main

on:
  push:
    branches: [main]

permissions:
  contents: read
  packages: write

jobs:
  terraform-checks:
    name: Terraform Validate & Lint
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    steps:
      - uses: actions/checkout@v4

      # TODO: Set up Terraform 

      # TODO: Run terraform fmt -check

      # TODO: Run terraform init -backend=false

      # TODO: Run terraform validate

      # TODO: Install and run tflint

      # TODO: Run checkov or tfsec against the terraform directory

  docker-lint:
    name: Dockerfile Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Run hadolint on app/Dockerfile

  docker-build-and-scan:
    name: Docker Build & Trivy Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Build the Docker image from app/Dockerfile

      # TODO: Run Trivy vulnerability scanner on the built image

  app-security:
    name: Application Security Scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Run npm audit or trivy fs on the app directory

  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # TODO: Run gitleaks to detect any hardcoded secrets

  docker-compose-test:
    name: Docker Compose Integration Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # TODO: Start services with docker compose up -d

      # TODO: Wait for services to be healthy

      # TODO: Curl localhost:3000/api/db-check and verify a successful response

      # TODO: Tear down with docker compose down

  build-and-push:
    name: Build & Push to GHCR
    runs-on: ubuntu-latest
    needs:
      - terraform-checks
      - docker-lint
      - docker-build-and-scan
      - app-security
      - secret-detection
      - docker-compose-test
    steps:
      - uses: actions/checkout@v4

      # TODO: Log in to GHCR
      # Hint: use docker/login-action with registry ghcr.io
      #       username: ${{ github.actor }}
      #       password: ${{ secrets.GITHUB_TOKEN }}

      # TODO: Build the Docker image

      # TODO: Tag the image with the Git SHA and "latest"
      # Hint: ghcr.io/${{ github.repository }}:${{ github.sha }}
      #       ghcr.io/${{ github.repository }}:latest

      # TODO: Push both tags to GHCR
